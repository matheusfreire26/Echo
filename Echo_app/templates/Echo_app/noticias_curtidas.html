{% extends "Echo_app/base.html" %}
{% load static %}

{% block title %}Minhas Curtidas{% endblock %}

{% block extra_css %}
<!-- Link para o CSS principal (manter) -->
<link rel="stylesheet" href="{% static 'Echo_app/css/lista_noticias_jornal.css' %}?v={% now 'U' %}">

<!-- CORREÇÃO CRÍTICA DE CSS PARA GARANTIR CLICABILIDADE (SOBRESCRITA) -->
<style>
    /* 1. Garante que a seção de filtros tenha uma posição e z-index alto 
           para ficar no topo da hierarquia de clique.
    */
    .filter-section {
        position: relative;
        z-index: 100; /* Alto z-index para garantir que não está coberto */
        display: flex;
        flex-direction: column;
        gap: 15px; 
        margin-bottom: 25px;
    }
    
    /* 2. Garante que o container dos botões seja um flex container e tenha 
           z-index ainda mais alto.
    */
    .category-filters {
        position: relative; 
        z-index: 110; 
        display: flex;
        flex-wrap: nowrap; /* Impede quebras inesperadas */
        overflow-x: auto; 
        padding-bottom: 8px;
        margin-left: -5px; 
    }

    /* 3. O Link (<a>) deve ser o elemento mais importante e com cursor ativo.
    */
    .filter-button {
        display: inline-flex; /* Usar inline-flex para centralização e garantia de bloco */
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        text-decoration: none;
        padding: 8px 16px;
        margin-right: 8px;
        border-radius: 9999px; 
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        border: 1px solid #ccc; 
        background-color: #f7f7f7;
        color: #333;
        cursor: pointer;
        user-select: none; /* Impede seleção de texto acidental */
        /* Z-index explícito para o botão, como última garantia */
        z-index: 120; 
    }
    
    .filter-button:hover {
        background-color: #e0e0e0;
    }
    
    .filter-button.active {
        background-color: #dc3545; 
        color: white;
        border-color: #dc3545;
    }
    
    /* Garante que o input de pesquisa não interfira visualmente ou estruturalmente */
    .search-form {
        position: relative;
        z-index: 90; 
    }
</style>
{% endblock %}

{% block content %}

<div class="content-container">

    <!-- Título principal -->
    <h1 class="main-title">Minhas Curtidas</h1>
    
    <!-- ============================================== -->
    <!-- SEÇÃO: BARRA DE PESQUISA E FILTROS -->
    <!-- ============================================== -->
    <div class="filter-section">
        
        <!-- Barra de Pesquisa -->
        <form method="GET" class="search-form" action="{% url 'Echo_app:noticias_curtidas' %}">
            
            <input type="text" name="q" placeholder="Pesquisar..." class="search-input" value="{{ request.GET.q|default:'' }}">
            
            <!-- CAMPO OCULTO: Mantém o filtro de categoria ativo durante a pesquisa. -->
            {% if categoria_ativa %}
                <input type="hidden" name="categoria" value="{{ categoria_ativa }}">
            {% endif %}

            <button type="submit" class="search-button">
                <i class="fas fa-search"></i>
            </button>
        </form>
        
        <!-- Filtros de Categoria: DEVE SER CLICÁVEL -->
        <div class="category-filters">
            
            {% url 'Echo_app:noticias_curtidas' as curtidas_url %}
            
            <!-- Usa o termo de pesquisa (q_param) do GET e a variável do contexto (categoria_ativa) -->
            {% with q_param=request.GET.q|default:'' %}
            
            <!-- 1. Botão "Tudo" -->
            <!-- Link 'Tudo' deve remover o parâmetro 'categoria' e manter 'q' -->
            <a href="{{ curtidas_url }}?q={{ q_param }}" 
               class="filter-button {% if not categoria_ativa %}active{% endif %}">
                Tudo
            </a>
            
            <!-- 2. Botões de Categoria -->
            {% for categoria in categorias_disponiveis %}
                <!-- 
                    A URL passa o slug da categoria e MANTER o termo de pesquisa.
                    A condição 'active' usa o slug da categoria atual e a variável 'categoria_ativa' do contexto.
                -->
                <a href="{{ curtidas_url }}?categoria={{ categoria.slug }}&q={{ q_param }}" 
                   class="filter-button {% if categoria_ativa|lower == categoria.slug|lower %}active{% endif %}">
                    {{ categoria.nome }}
                </a>
            {% endfor %}
            
            {% endwith %}

        </div>
    </div>
    <!-- ============================================== -->
    <!-- FIM DA SEÇÃO CORRIGIDA -->
    <!-- ============================================== -->

    <div class="curtidas-header">
        <p class="curtidas-info">
            {% if categoria_ativa %}
                Mostrando notícias curtidas na categoria <strong>"{{ categoria_ativa|title }}"</strong>.
            {% endif %}
            Total de notícias curtidas: <strong>{{ noticias_curtidas|length }}</strong>.
        </p>
    </div>

    {% if noticias_curtidas %}
        
        <!-- Lista de Notícias no formato Jornal -->
        <div class="noticias-listagem">
            
            {% for noticia in noticias_curtidas %}
            <article class="noticia-item">
                
                <a href="{% url 'Echo_app:noticia_detalhe' pk=noticia.pk %}" class="noticia-link">
                    
                    <!-- Imagem/Placeholder -->
                    <div class="noticia-imagem-box">
                        {% if noticia.imagem %}
                            <img 
                                src="{{ noticia.imagem.url }}" 
                                alt="Imagem da notícia: {{ noticia.titulo }}" 
                                class="noticia-imagem"
                            >
                        {% else %}
                            <div class="imagem-placeholder">
                                <i class="fas fa-image"></i>
                                <span>Sem Imagem</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Corpo do Texto -->
                    <div class="noticia-body">
                        <!-- Categoria no estilo tag -->
                        <span class="noticia-tag tag-{{ noticia.categoria.nome|slugify|default:'geral' }}">
                            {{ noticia.categoria.nome|default:"Geral" }}
                        </span>
                        
                        <h2 class="noticia-titulo">
                            {{ noticia.titulo }}
                        </h2>
                        
                        <p class="noticia-resumo">
                            {{ noticia.conteudo|safe|striptags|truncatechars:150 }}
                        </p>
                        
                        <div class="noticia-meta">
                            <span class="meta-data">
                                {{ noticia.data_publicacao|date:"d/m/Y \à\s H:i" }}
                            </span>
                            <!-- Ícone de Curtido para indicar que está na lista -->
                            <span class="meta-curtida">
                                <i class="fas fa-heart"></i>
                            </span>
                        </div>
                    </div>
                    
                </a>
            </article>
            {% endfor %}
            
        </div>
        
    {% else %}
        <!-- Mensagem de estado vazio (Empty State) -->
        <div class="empty-state">
            <i class="fas fa-heart-broken empty-icon"></i>
            <h3 class="empty-title">Nenhuma notícia curtida</h3>
            <p class="empty-text">
                Explore o dashboard e clique no coração nas notícias que mais te interessarem.
            </p>
            <a href="{% url 'Echo_app:dashboard' %}" class="empty-btn-link">
                <i class="fas fa-arrow-left"></i>
                Voltar para o Dashboard
            </a>
        </div>
    {% endif %}
</div>

{% endblock %}