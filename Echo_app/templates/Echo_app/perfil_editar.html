{% extends 'Echo_app/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'Echo_app/css/perfil_editar.css' %}">
{% endblock %}

{% block content %}
<div class="edit-profile-container" style="max-width: 900px; margin: 20px auto; padding: 0 20px; font-family: 'Segoe UI', sans-serif;">
    
    <h2 style="text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 1.8rem; color: #1a1a1a;">
        Editar Perfil
    </h2>

    <div class="edit-profile-card" style="background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 20px 20px 0 20px; border: 1px solid #e0e0e0;">
        
        <form method="POST" action="{% url 'Echo_app:perfil_editar' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="avatar_escolhido" id="avatar_escolhido">
            <input type="file" name="foto_perfil" id="real-file-input" style="display: none;" accept="image/*">

            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; padding-bottom: 0;">
                
                <div id="avatar-display" onclick="openModal()"
                     style="
                        width: 150px; 
                        height: 150px; 
                        min-width: 150px;
                        min-height: 150px;
                        border-radius: 50%; 
                        cursor: pointer; 
                        position: relative; 
                        border: 4px solid #fff;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
                        background-color: #eee;
                        background-position: center;
                        background-size: 500%;
                        background-repeat: no-repeat;
                        background-image: url('{% if perfil.foto_perfil %}{{ perfil.foto_perfil.url }}?v={% now 'U' %}{% else %}https://ui-avatars.com/api/?name={{ request.user.first_name|default:request.user.username }}&background=0D8ABC&color=fff&size=512{% endif %}');
                     ">
                    
                    <div style="position: absolute; bottom: 0; right: 0; width: 40px; height: 40px; background: #fff; border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #333; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        ✎
                    </div>
                </div>
                
            </div>
            <h3 style="font-size: 1.4rem; font-weight: 700; color: #333; margin: 10px 0 20px 0;">
                Suas informações
            </h3>

            <div style="margin-bottom: 25px;">
                <input type="text" name="first_name" value="{{ usuario.first_name|default:'' }}" required placeholder="Nome *"
                       style="width: 100%; padding: 15px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;">
                
                <input type="text" name="last_name" value="{{ usuario.last_name|default:'' }}" placeholder="Sobrenome"
                       style="width: 100%; padding: 15px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;">

                <input type="tel" name="telefone" value="" placeholder="Número de telefone"
                       style="width: 100%; padding: 15px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;">
                
                <input type="email" name="email" value="{{ usuario.email }}" required placeholder="Email *"
                       style="width: 100%; padding: 15px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;">
            </div>
            <div class="form-section" style="margin-top: 40px; margin-bottom: 35px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3 class="section-title" style="font-size: 1.4rem; font-weight: 700; color: #333; margin-bottom: 20px; padding-bottom: 0;">
                    Categorias de interesse
                </h3>
                
                {% if todas_categorias %}
                    <div class="categories-grid" style="padding-bottom: 15px;">
                        {% for categoria in todas_categorias %}
                            
                            <label class="category-pill {% if categoria in perfil.categorias_de_interesse.all %}selected{% endif %}"
                                   onclick="
                                        const input = this.querySelector('input'); 
                                        input.checked = !input.checked; 
                                        this.classList.toggle('selected', input.checked);"
                                   style="user-select: none;">
                                
                                <input type="checkbox" name="categoria" value="{{ categoria.id }}" 
                                       {% if categoria in perfil.categorias_de_interesse.all %}checked{% endif %}
                                       style="display: none;">
                                
                                <span class="pill-icon">
                                    {% if categoria in perfil.categorias_de_interesse.all %}
                                        ✓
                                    {% else %}
                                        +
                                    {% endif %}
                                </span>
                                {{ categoria.nome }}
                            </label>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-categories" style="text-align: center; color: #999; font-style: italic; padding: 15px;">
                        Nenhuma categoria disponível no momento.
                    </p>
                {% endif %}
            </div>
            
            <div style="display: flex; gap: 15px; padding: 20px 0; border-top: 1px solid #eee; margin-top: 10px;">
                <a href="{% url 'Echo_app:perfil' %}" 
                   style="flex: 1; padding: 15px; border-radius: 50px; background: #fff; color: #dc2626; font-weight: 700; border: 2px solid #dc2626; text-align: center; text-decoration: none;">
                   Cancelar
                </a>
                <button type="submit" 
                        style="flex: 1; padding: 15px; border-radius: 50px; background: #dc2626; color: white; font-weight: 700; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3);">
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<div id="avatarModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; text-align: center;">
        <span onclick="closeModal()" style="position: absolute; top: 15px; right: 20px; font-size: 30px; cursor: pointer; color: #999;">&times;</span>
        
        <h3 style="margin-bottom: 10px; color: #333;">Escolha seu Avatar</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 20px; margin-top: 30px; padding: 10px;">
            {% for avatar_file in lista_avatars %}
            <div class="avatar-grid-item-container" 
                onclick="selectAvatarFromGrid('{{ avatar_file }}', '{% static 'avatars/'|add:avatar_file %}')"
                style="cursor: pointer; position: relative; width: 100%; padding-top: 100%; border-radius: 50%; overflow: hidden; background-color: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s;"
                onmouseover="this.style.transform='scale(1.1)'" 
                onmouseout="this.style.transform='scale(1)'">
            
                <img src="{% static 'avatars/'|add:avatar_file %}" 
                    alt="Avatar"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scale(4.2);">
            </div>
            {% endfor %}
        </div>

        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <button type="button" onclick="document.getElementById('real-file-input').click()" 
                    style="background: #fff; border: 2px solid #ddd; padding: 10px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; color: #555;">
                Carregar do Computador
            </button>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('avatarModal');
    const avatarDisplay = document.getElementById('avatar-display');
    const hiddenAvatarInput = document.getElementById('avatar_escolhido');
    const fileInput = document.getElementById('real-file-input');

    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }
    window.onclick = function(e) { if (e.target == modal) closeModal(); }

    function selectAvatarFromGrid(filename, imgSrc) {
        hiddenAvatarInput.value = filename;
        avatarDisplay.style.backgroundImage = `url('${imgSrc}')`;
        fileInput.value = ""; 
        closeModal();
    }

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                avatarDisplay.style.backgroundImage = `url('${evt.target.result}')`;
            }
            reader.readAsDataURL(file);
            hiddenAvatarInput.value = ""; 
            closeModal();
        }
    });
</script>
{% endblock %}